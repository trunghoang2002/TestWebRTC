const socket = io('http://localhost:3000');
let localStream = null;
let selectedDeviceId = null; // ID c·ªßa camera ƒë∆∞·ª£c ch·ªçn
let currentCall = null;
let isUsingFile = false;
let videoFile = null;
let isPaused = false;

$('#notification-bar').hide();
$('#main').hide();

// L·∫•y danh s√°ch thi·∫øt b·ªã camera v√† c·∫≠p nh·∫≠t dropdown
async function loadCameraList() {
    console.log("ƒêang l·∫•y danh s√°ch camera...");
    const videoDevices = await navigator.mediaDevices.enumerateDevices();
    console.log("Danh s√°ch thi·∫øt b·ªã:", videoDevices);

    const cameras = videoDevices.filter(device => device.kind === 'videoinput');
    console.log("Danh s√°ch camera:", cameras);

    const cameraSelect = document.getElementById('camera-select');
    cameraSelect.innerHTML = ""; // X√≥a danh s√°ch c≈©

    if (cameras.length === 0) {
        console.error("Kh√¥ng t√¨m th·∫•y camera n√†o!");
        return;
    }

    cameras.forEach((camera, index) => {
        const option = document.createElement('option');
        option.value = camera.deviceId;
        option.text = camera.label || `Camera ${index + 1}`;
        cameraSelect.appendChild(option);
    });

    // Ch·ªçn camera ƒë·∫ßu ti√™n m·∫∑c ƒë·ªãnh
    selectedDeviceId = cameras[0].deviceId;
    console.log("Camera m·∫∑c ƒë·ªãnh ƒë∆∞·ª£c ch·ªçn:", selectedDeviceId);
    return selectedDeviceId;
}

// Khi ng∆∞·ªùi d√πng ch·ªçn camera, c·∫≠p nh·∫≠t selectedDeviceId
document.getElementById('camera-select').addEventListener('change', function () {
    selectedDeviceId = this.value;
});

async function openStream(deviceId) {
    const config = {
        audio: false,
        video: { deviceId: deviceId ? { exact: deviceId } : undefined }
    };
    return navigator.mediaDevices.getUserMedia(config);
}

// Ph√°t stream l√™n video tag
function playStream(idVideoTag, stream) {
    const video = document.getElementById(idVideoTag);
    video.srcObject = stream;
    video.play();
}

// M·ªü camera v·ªõi deviceId ƒë∆∞·ª£c ch·ªçn
async function startCamera() {
    if (selectedDeviceId === null) {
        console.error("Ch∆∞a ch·ªçn camera.");
        selectedDeviceId = await loadCameraList(); // Th·ª≠ t·∫£i l·∫°i danh s√°ch camera
        console.log("selectedDeviceId: ", selectedDeviceId)
        if (!selectedDeviceId) return; // N·∫øu v·∫´n kh√¥ng c√≥ th√¨ d·ª´ng
    }

    if (localStream) {
        stopCameraAndVideo(); // T·∫Øt camera tr∆∞·ªõc khi b·∫≠t camera m·ªõi
    }

    try {
        localStream = await openStream(selectedDeviceId);
        playStream('localStream', localStream);
    } catch (error) {
        console.error("L·ªói m·ªü camera:", error);
        alert("Kh√¥ng th·ªÉ m·ªü camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p.");
    }
}

// T·∫Øt camera
function stopCameraAndVideo() {
    if (localStream) {
        localStream.getTracks().forEach(track => track.stop());
        document.getElementById('localStream').srcObject = null;
        localStream = null;
    }
    if (isUsingFile) {
        document.getElementById('localStream').src = "";
        isUsingFile = false;
    }
}

// Load danh s√°ch camera khi trang t·∫£i
loadCameraList().then(deviceId => {
    if (deviceId) {
        selectedDeviceId = deviceId; // ƒê·∫£m b·∫£o selectedDeviceId c√≥ gi√° tr·ªã h·ª£p l·ªá
    }
});


// B·∫≠t camera
$('#start-camera').click(() => {
    isUsingFile = false;
    startCamera();
});
// T·∫Øt camera
$('#stop-camera').click(() => {
    stopCameraAndVideo();
});

// Kh·ªüi t·∫°o PeerJS
var peer = new Peer();
peer.on('open', id => {
    $('#my-peer').append(id)
    // ƒêƒÉng k√≠ user
    $('#signup').click(() => {
        const username = $('#txtUsername').val();
        socket.emit('signup', { username: username, peerId: id });
    });
});

function handleStartCall(Id) {
    if (Id === peer.id) {
        alert("Kh√¥ng th·ªÉ g·ªçi cho ch√≠nh m√¨nh!");
        return;
    }

    if (currentCall) {
        alert("B·∫°n ƒëang trong cu·ªôc g·ªçi. H√£y k·∫øt th√∫c tr∆∞·ªõc khi g·ªçi ti·∫øp.");
        return;
    }

    // socket.emit("check-user-status", { peerId: Id }, (response) => {
    //     if (response.status === "busy") {
    //         alert("Ng∆∞·ªùi nh·∫≠n ƒëang b·∫≠n. H√£y th·ª≠ l·∫°i sau!");
    //     } else {
    //         socket.emit("update-status", { peerId: peer.id, status: "busy" });
    //         if (!localStream) {
    //             startCamera().then(() => {
    //                 startCall(Id);
    //             });    
    //         }
    //         else {
    //             startCall(Id);
    //         }
    //     }
    // });

    socket.emit("update-status", { peerId: peer.id, status: "busy" });
    if (!localStream && !isUsingFile) {
        startCamera().then(() => {
            startCall(Id);
        });    
    }
    else {
        startCall(Id);
    }
}

function startCall(Id) {
    let streamToSend = isUsingFile ? document.getElementById('localStream').captureStream() : localStream;
    const call = peer.call(Id, streamToSend);
    currentCall = call;
    console.log("currentCall: ", currentCall);

    username = getUsernamebypeerId(Id);
    $('#call-status').text(`üìû ƒêang g·ªçi ${username}...`).show();

    call.on('stream', remoteStream => {
        playStream('remoteStream', remoteStream);
        $('#end-call').show();
    });

    call.on('close', () => {
        console.log("end call with ", username)
        endCall();
    });
}

function handleIncomingCall(call) {
    const fromPeerId = call.peer;
    const username = getUsernamebypeerId(fromPeerId);
    console.log("Incomming call from: ", username);

    if (currentCall) {
        // N·∫øu ƒë√£ c√≥ cu·ªôc g·ªçi, h·ªèi ng∆∞·ªùi d√πng c√≥ mu·ªën chuy·ªÉn cu·ªôc g·ªçi kh√¥ng
        const acceptSwitch = confirm(`üìû ${username} ƒëang g·ªçi cho b·∫°n. B·∫°n c√≥ mu·ªën chuy·ªÉn cu·ªôc g·ªçi kh√¥ng?`);

        if (acceptSwitch) {
            currentCall.close(); // K·∫øt th√∫c cu·ªôc g·ªçi c≈©
            socket.emit("update-status", { peerId: peer.id, status: "busy" });
            if (!localStream && !isUsingFile) {
                startCamera().then(() => {
                    acceptCall(call);
                });
            } else {
                acceptCall(call);
            }
        } else {
            // G·ª≠i th√¥ng b√°o t·ª´ ch·ªëi qua PeerJS Data Connection
            const conn = peer.connect(fromPeerId);
            conn.on('open', () => {
                conn.send({ type: "call-rejected", message: "Ng∆∞·ªùi nh·∫≠n ƒëang b·∫≠n v√† t·ª´ ch·ªëi cu·ªôc g·ªçi." });
            });
        }
    } else {
        const accept = confirm(`üìû ${username} ƒëang g·ªçi cho b·∫°n. Ch·∫•p nh·∫≠n kh√¥ng?`);
        if (accept) {
            socket.emit("update-status", { peerId: peer.id, status: "busy" });
             if (!localStream && !isUsingFile) {
                startCamera().then(() => {
                    acceptCall(call);
                });
            } else {
                acceptCall(call);
            }
        }
        else {
            // G·ª≠i th√¥ng b√°o t·ª´ ch·ªëi qua PeerJS Data Connection
            const conn = peer.connect(fromPeerId);
            conn.on('open', () => {
                conn.send({ type: "call-rejected", message: "Ng∆∞·ªùi nh·∫≠n ƒëang b·∫≠n v√† t·ª´ ch·ªëi cu·ªôc g·ªçi." });
            });
        }
    }
}

function acceptCall(call) {
    let streamToSend = isUsingFile ? document.getElementById('localStream').captureStream() : localStream;
    call.answer(streamToSend);
    currentCall = call;

    const username = getUsernamebypeerId(call.peer);
    $('#call-status').text(`üìû ƒêang nh·∫≠n cu·ªôc g·ªçi t·ª´ ${username}`).show();

    call.on('stream', remoteStream => {
        playStream('remoteStream', remoteStream);
        $('#end-call').show();
    });

    call.on('close', () => {
        console.log("end call with ", username)
        endCall();
    });
}

function endCall() {
    if (currentCall) {
        currentCall.close(); // ƒê√≥ng cu·ªôc g·ªçi
        currentCall = null;  // Reset bi·∫øn cu·ªôc g·ªçi
        socket.emit("end-call", { peerId: peer.id }); // C·∫≠p nh·∫≠t tr·∫°ng th√°i server
    }

    // T·∫Øt camera
    stopCameraAndVideo();

    // ·∫®n remote video, n√∫t k·∫øt th√∫c cu·ªôc g·ªçi v√† th√¥ng b√°o tr·∫°ng th√°i cu·ªôc g·ªçi
    const remoteVideo = $('#remoteStream').get(0);
    if (remoteVideo) {
        remoteVideo.srcObject = null;
    }
    $('#end-call').hide();
    $('#call-status').hide();
}

// X·ª≠ l√Ω t·∫£i video t·ª´ file
$('#video-upload').change((event) => {
    videoFile = event.target.files[0];
    if (videoFile) {
        $('#start-video').show();
    }
});

// B·∫Øt ƒë·∫ßu ph√°t video t·ª´ file
$('#start-video').click(() => {
    if (!videoFile) return;
    $('#pause-video').show();

    const videoElement = document.getElementById('localStream');
    if (!isUsingFile) {
        // N·∫øu ch∆∞a ph√°t, t·∫°o stream v√† play
        const objectURL = URL.createObjectURL(videoFile);
        videoElement.src = objectURL;
        videoElement.play();
        isUsingFile = true;

        //T·∫°o stream t·ª´ video file
        videoElement.onloadeddata = () => {
            localStream = videoElement.captureStream();
        };
    } else if (isPaused) {
        // N·∫øu ƒëang t·∫°m d·ª´ng, ti·∫øp t·ª•c ph√°t
        videoElement.play();
    }

    isPaused = false;
});

// D·ª´ng ph√°t video t·ª´ file
$('#pause-video').click(() => {
    const videoElement = document.getElementById('localStream');
    videoElement.pause();
    isPaused = true;
    $('#pause-video').hide();
});

// Caller
$('#connect').click(() => {
    const Id = $('#remote-peer').val();
    handleStartCall(Id);
});

// G·ªçi cho user kh√°c ƒëang online
$('#listUser').on('click', '.user-item', function () {
    const Id = $(this).attr('id');
    handleStartCall(Id);
});

// Callee
peer.on('call', call => {
    handleIncomingCall(call);
});

// S·ª± ki·ªán k·∫øt th√∫c cu·ªôc g·ªçi
$('#end-call').click(() => {
    username = getUsernamebypeerId(currentCall.peer);
    console.log("end call with ", username)
    endCall();
});

// S·ª± ki·ªán nh·∫≠n th√¥ng b√°o khi ng∆∞·ªùi d√πng t·ª´ ch·ªëi cu·ªôc g·ªçi
peer.on('connection', conn => {
    conn.on('data', data => {
        if (data.type === "call-rejected") {
            endCall();
            alert(data.message);
        }
    });
});

// S·ª± ki·ªán logout
$('#logout').click(() => {
    socket.emit('logout');
    // socket.disconnect();
    peer.destroy();
    stopCameraAndVideo();
    $('#main').hide();
    $('#register').show();
});

// Nh·∫≠n th√¥ng b√°o t·ª´ server
socket.on('signup-success', username => {
    alert("ƒêƒÉng k√≠ th√†nh c√¥ng!");
    $('#register').hide();
    $('#main').show();
    $('#my-username').append(username);
    $('#txtUsername').val(''); // Reset l·∫°i input

    socket.on('new-user', username => {
        showNotification(`User m·ªõi ƒëƒÉng k√Ω: ${username}`);
        showTitleNotification(`üîî User m·ªõi: ${username}`);
    });
});

socket.on('signup-failed', () => {
    alert("T√™n ng∆∞·ªùi d√πng ƒë√£ t·ªìn t·∫°i!");
});

socket.on('list-all-user', (data) => {
    $('#listUser').empty(); // X√≥a danh s√°ch c≈©
    userInfos = data.users;
    userStatus = data.status;
    userInfos.forEach(u => {
        const isBusy = userStatus[u.peerId] === "busy";
        console.log(u.username, " is busy or not: ", isBusy);
        $('#listUser').append(`<button class="user-item ${isBusy ? 'busy' : 'idle'}" id="${u.peerId}">${u.username}</button>`);
    });
});

socket.on('user-disconnected', user => {
    showNotification(`User ${user.username} ƒë√£ tho√°t.`);
    showTitleNotification(`User ${user.username} ƒë√£ tho√°t.`);
    $(`#${user.peerId}`).remove();
});

socket.on('update-user-status', (data) => {
    id = data.peerId;
    stat = data.status;
    $('#listUser').find(`#${id}`).removeClass('busy idle').addClass(stat);
});

function showNotification(text) {
    const bar = document.getElementById('notification-bar');
    bar.textContent = text;
    bar.style.display = "block";

    setTimeout(() => {
        bar.style.display = "none";
    }, 3000); // ·∫®n sau 3 gi√¢y
}

function showTitleNotification(text) {
    document.title = text;
    
    setTimeout(() => {
        document.title = "Trang c·ªßa b·∫°n";  // Reset l·∫°i ti√™u ƒë·ªÅ
    }, 5000);
}

function getUsernamebypeerId(id) {
    return $(`#${id}`).text();
}